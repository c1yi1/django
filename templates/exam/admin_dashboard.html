{% extends 'base.html' %}
{% load static %}
{% block title %}控制台 - 智能学习系统{% endblock %}

{% block header_nav %}
<nav class="header-nav">
    <a href="{% url 'exam:admin_dashboard' %}" class="nav-link active">
        <i class="ri-dashboard-3-line"></i> 控制台
    </a>
    <a href="{% url 'exam:exam_list' %}" class="nav-link">
        <i class="ri-calendar-check-line"></i> 考试管理
    </a>
    <a href="{% url 'exam:question_list' %}" class="nav-link">
        <i class="ri-file-list-3-line"></i> 题库管理
    </a>
    <a href="{% url 'exam:exam_statistics_entry' %}" class="nav-link">
        <i class="ri-pie-chart-line"></i> 成绩统计
    </a>
    {% if request.user.is_superuser %}
    <a href="/admin/" class="nav-link">
        <i class="ri-shield-user-line"></i> 用户管理
    </a>
    {% endif %}
</nav>
{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }
    
    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .stat-card {
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .stat-card:hover::before {
        opacity: 1;
    }
    
    .stat-card.primary .stat-icon { background: rgba(56, 239, 213, 0.15); color: var(--accent-primary); }
    .stat-card.blue .stat-icon { background: rgba(0, 187, 249, 0.15); color: var(--accent-secondary); }
    .stat-card.purple .stat-icon { background: rgba(155, 93, 229, 0.15); color: var(--accent-purple); }
    .stat-card.orange .stat-icon { background: rgba(249, 115, 22, 0.15); color: var(--accent-orange); }
    .stat-card.yellow .stat-icon { background: rgba(251, 191, 36, 0.15); color: var(--accent-yellow); }
    
    .chart-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-title i {
        color: var(--accent-primary);
    }
    
    .chart-tabs {
        display: flex;
        gap: 8px;
    }
    
    .chart-tab {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
        border: 1px solid transparent;
    }
    
    .chart-tab:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-secondary);
    }
    
    .chart-tab.active {
        background: rgba(56, 239, 213, 0.15);
        color: var(--accent-primary);
        border-color: rgba(56, 239, 213, 0.3);
    }
    
    .chart-container {
        height: 400px;
        width: 100%;
    }
    
    .chart-wrapper {
        display: none;
    }
    
    .chart-wrapper.active {
        display: block;
    }
    
    .empty-chart {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: var(--text-muted);
    }
    
    .empty-chart i {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
    }
    
    .quick-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 32px;
    }
    
    .quick-link {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s;
    }
    
    .quick-link:hover {
        border-color: var(--border-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-glow);
    }
    
    .quick-link-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
    }
    
    .quick-link-icon.teal { background: rgba(56, 239, 213, 0.15); color: var(--accent-primary); }
    .quick-link-icon.blue { background: rgba(0, 187, 249, 0.15); color: var(--accent-secondary); }
    .quick-link-icon.purple { background: rgba(155, 93, 229, 0.15); color: var(--accent-purple); }
    .quick-link-icon.orange { background: rgba(249, 115, 22, 0.15); color: var(--accent-orange); }
    
    .quick-link-text {
        flex: 1;
    }
    
    .quick-link-title {
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .quick-link-desc {
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .quick-link-arrow {
        color: var(--text-muted);
        transition: transform 0.3s;
    }
    
    .quick-link:hover .quick-link-arrow {
        transform: translateX(4px);
        color: var(--accent-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="ri-dashboard-3-line"></i>
        控制台
    </h1>
    <p class="page-subtitle">系统数据总览与快捷操作入口</p>
</div>

<!-- 统计卡片 -->
<div class="dashboard-grid">
    <div class="stat-card primary">
        <div class="stat-icon"><i class="ri-user-3-line"></i></div>
        <div class="stat-value">{{ total_students }}</div>
        <div class="stat-label">学生总数</div>
    </div>
    <div class="stat-card blue">
        <div class="stat-icon"><i class="ri-user-star-line"></i></div>
        <div class="stat-value">{{ total_teachers }}</div>
        <div class="stat-label">教师/管理员</div>
    </div>
    <div class="stat-card purple">
        <div class="stat-icon"><i class="ri-calendar-check-line"></i></div>
        <div class="stat-value">{{ total_exams }}</div>
        <div class="stat-label">考试总数</div>
    </div>
    <div class="stat-card orange">
        <div class="stat-icon"><i class="ri-file-list-3-line"></i></div>
        <div class="stat-value">{{ total_questions }}</div>
        <div class="stat-label">题目总数</div>
    </div>
    <div class="stat-card yellow">
        <div class="stat-icon"><i class="ri-calendar-todo-line"></i></div>
        <div class="stat-value">{{ today_exams }}</div>
        <div class="stat-label">今日考试</div>
    </div>
</div>

<!-- 图表区域 -->
<div class="chart-card">
    <div class="chart-header">
        <h3 class="chart-title">
            <i class="ri-line-chart-line"></i>
            考试成绩趋势
        </h3>
        {% if chart_labels and chart_scores and chart_labels != '[]' %}
        <div class="chart-tabs">
            <div class="chart-tab active" data-target="line">
                <i class="ri-line-chart-line"></i> 折线图
            </div>
            <div class="chart-tab" data-target="bar">
                <i class="ri-bar-chart-line"></i> 柱状图
            </div>
        </div>
        {% endif %}
    </div>
    
    {% if chart_labels and chart_scores and chart_labels != '[]' %}
    <div class="chart-wrapper active" id="line-wrapper">
        <div id="line-chart" class="chart-container"></div>
    </div>
    <div class="chart-wrapper" id="bar-wrapper">
        <div id="bar-chart" class="chart-container"></div>
    </div>
    {% else %}
    <div class="empty-chart">
        <i class="ri-bar-chart-box-line"></i>
        <p>暂无考试成绩数据</p>
    </div>
    {% endif %}
</div>

<!-- 快捷入口 -->
<div class="quick-links">
    <a href="{% url 'exam:exam_create' %}" class="quick-link">
        <div class="quick-link-icon teal"><i class="ri-add-circle-line"></i></div>
        <div class="quick-link-text">
            <div class="quick-link-title">创建考试</div>
            <div class="quick-link-desc">新建考试并配置试卷</div>
        </div>
        <i class="ri-arrow-right-s-line quick-link-arrow"></i>
    </a>
    <a href="{% url 'exam:question_create' %}" class="quick-link">
        <div class="quick-link-icon blue"><i class="ri-file-add-line"></i></div>
        <div class="quick-link-text">
            <div class="quick-link-title">添加题目</div>
            <div class="quick-link-desc">向题库添加新题目</div>
        </div>
        <i class="ri-arrow-right-s-line quick-link-arrow"></i>
    </a>
    <a href="{% url 'exam:question_import' %}" class="quick-link">
        <div class="quick-link-icon purple"><i class="ri-upload-2-line"></i></div>
        <div class="quick-link-text">
            <div class="quick-link-title">批量导入</div>
            <div class="quick-link-desc">从文件导入题目</div>
        </div>
        <i class="ri-arrow-right-s-line quick-link-arrow"></i>
    </a>
    <a href="{% url 'exam:exam_statistics_entry' %}" class="quick-link">
        <div class="quick-link-icon orange"><i class="ri-pie-chart-line"></i></div>
        <div class="quick-link-text">
            <div class="quick-link-title">成绩分析</div>
            <div class="quick-link-desc">查看考试成绩统计</div>
        </div>
        <i class="ri-arrow-right-s-line quick-link-arrow"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
{% if chart_labels and chart_scores and chart_labels != '[]' %}
{{ chart_labels|json_script:"chart-labels" }}
{{ chart_scores|json_script:"chart-scores" }}
<script src="{% static 'js/echarts.min.js' %}"></script>
<script>
(function() {
    const labels = JSON.parse(document.getElementById('chart-labels').textContent || '[]');
    const scores = JSON.parse(document.getElementById('chart-scores').textContent || '[]');
    
    // 深色主题配置
    const darkTheme = {
        backgroundColor: 'transparent',
        textStyle: { color: 'rgba(255,255,255,0.7)' },
        axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
    };
    
    const initLineChart = function() {
        const dom = document.getElementById('line-chart');
        if (!dom || typeof echarts === 'undefined') {
            console.warn('ECharts 未加载或找不到 line-chart 容器，无法初始化折线图');
            return;
        }
        const chart = echarts.init(dom);
        chart.setOption({
            backgroundColor: 'transparent',
            tooltip: { 
                trigger: 'axis',
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                borderColor: 'rgba(56, 239, 213, 0.3)',
                textStyle: { color: '#fff' }
            },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { 
                type: 'category', 
                data: labels,
                axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                axisLabel: { color: 'rgba(255,255,255,0.5)' }
            },
            yAxis: { 
                type: 'value', 
                name: '平均分',
                nameTextStyle: { color: 'rgba(255,255,255,0.5)' },
                axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                axisLabel: { color: 'rgba(255,255,255,0.5)' },
                splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
            },
            series: [{
                name: '平均分',
                type: 'line',
                smooth: true,
                data: scores,
                lineStyle: { color: '#38efd5', width: 3 },
                itemStyle: { color: '#38efd5' },
                areaStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(56, 239, 213, 0.3)' },
                            { offset: 1, color: 'rgba(56, 239, 213, 0)' }
                        ]
                    }
                }
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    };

    const initBarChart = function() {
        const dom = document.getElementById('bar-chart');
        if (!dom || typeof echarts === 'undefined') {
            console.warn('ECharts 未加载或找不到 bar-chart 容器，无法初始化柱状图');
            return;
        }
        const chart = echarts.init(dom);
        chart.setOption({
            backgroundColor: 'transparent',
            tooltip: { 
                trigger: 'axis',
                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                borderColor: 'rgba(56, 239, 213, 0.3)',
                textStyle: { color: '#fff' }
            },
            grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { 
                type: 'category', 
                data: labels,
                axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                axisLabel: { color: 'rgba(255,255,255,0.5)' }
            },
            yAxis: { 
                type: 'value', 
                name: '平均分',
                nameTextStyle: { color: 'rgba(255,255,255,0.5)' },
                axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
                axisLabel: { color: 'rgba(255,255,255,0.5)' },
                splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
            },
            series: [{
                name: '平均分',
                type: 'bar',
                data: scores,
                barWidth: '50%',
                itemStyle: {
                    color: {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: '#38efd5' },
                            { offset: 1, color: '#00bbf9' }
                        ]
                    },
                    borderRadius: [6, 6, 0, 0]
                }
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    };

    document.addEventListener('DOMContentLoaded', function() {
        initLineChart();

        const tabs = document.querySelectorAll('.chart-tab');
        tabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const target = tab.getAttribute('data-target');
                document.getElementById('line-wrapper').classList.remove('active');
                document.getElementById('bar-wrapper').classList.remove('active');
                if (target === 'line') {
                    document.getElementById('line-wrapper').classList.add('active');
                    initLineChart();
                } else {
                    document.getElementById('bar-wrapper').classList.add('active');
                    initBarChart();
                }
            });
        });
    });
})();
</script>
{% endif %}
{% endblock %}
