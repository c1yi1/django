<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºè¯•å· - {{ exam.title }} - åœ¨çº¿è€ƒè¯•å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f5f5; }
        .header { background: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px 40px; }
        .form-card { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tab-container { margin-top: 20px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; border: none; background: #f8f9fa; cursor: pointer; border-radius: 5px 5px 0 0; }
        .tab-button.active { background: white; border-bottom: 2px solid #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .question-list { max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 15px; }
        .question-item { padding: 15px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .question-title { font-weight: 600; color: #333; }
        .question-meta { font-size: 12px; color: #666; }
        .question-content { color: #555; margin-bottom: 10px; }
        .question-score { display: flex; align-items: center; gap: 10px; }
        .question-score input { width: 80px; }
        .filter-bar { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .filter-row { display: flex; gap: 15px; align-items: center; }
        .filter-item { display: flex; align-items: center; gap: 8px; }
        .filter-item label { font-weight: 600; color: #666; }
        .filter-item select { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div><strong>åˆ›å»ºè¯•å· - {{ exam.title }}</strong></div>
            <div>
                <a href="{% url 'exam:exam_detail' exam.id %}" class="btn btn-secondary">è¿”å›</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="form-card">
            <form method="post">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>è¯•å·åç§° *</label>
                    <input type="text" name="name" required placeholder="ä¾‹å¦‚ï¼šAå·">
                </div>
                
                <div class="form-group">
                    <label>ç”Ÿæˆæ–¹å¼ *</label>
                    <select name="generate_type" id="generate_type" onchange="toggleGenerateType()" required>
                        <option value="manual">æ‰‹åŠ¨é€‰é¢˜</option>
                        <option value="random">éšæœºç»„å·</option>
                    </select>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" onclick="switchTab('manual')">æ‰‹åŠ¨é€‰é¢˜</button>
                        <button type="button" class="tab-button" onclick="switchTab('random')">éšæœºç»„å·</button>
                    </div>
                    
                    <div id="manual_tab" class="tab-content active">
                        <div class="filter-bar">
                            <div class="filter-row">
                                <div class="filter-item">
                                    <label>åˆ†ç±»ï¼š</label>
                                    <select name="filter_category" id="filter_category">
                                        <option value="">å…¨éƒ¨</option>
                                        {% for cat in categories %}
                                        <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label>ç±»å‹ï¼š</label>
                                    <select name="filter_type" id="filter_type">
                                        <option value="">å…¨éƒ¨</option>
                                        <option value="single" {% if selected_type == 'single' %}selected{% endif %}>å•é€‰é¢˜</option>
                                        <option value="multiple" {% if selected_type == 'multiple' %}selected{% endif %}>å¤šé€‰é¢˜</option>
                                        <option value="judge" {% if selected_type == 'judge' %}selected{% endif %}>åˆ¤æ–­é¢˜</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="filterQuestions()">ç­›é€‰</button>
                            </div>
                        </div>
                        
                        <div class="question-list">
                            {% for question in questions %}
                            <div class="question-item">
                                <div class="question-header">
                                    <div>
                                        <div class="question-title">{{ question.title }}</div>
                                        <div class="question-meta">
                                            {{ question.get_question_type_display }} | 
                                            {{ question.get_difficulty_display }} | 
                                            {{ question.category.name|default:"æœªåˆ†ç±»" }}
                                        </div>
                                    </div>
                                    <div>
                                        <input type="checkbox" name="questions" value="{{ question.id }}" id="q{{ question.id }}">
                                    </div>
                                </div>
                                <div class="question-content">{{ question.content|truncatewords:30|safe }}</div>
                                <div class="question-score">
                                    <label>åˆ†å€¼ï¼š</label>
                                    <input type="number" name="score_{{ question.id }}" value="{{ question.score }}" min="1" disabled>
                                </div>
                            </div>
                            {% empty %}
                            <div style="text-align: center; padding: 40px; color: #999;">æš‚æ— é¢˜ç›®</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="random_tab" class="tab-content">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <p style="color: #1976d2; font-weight: 600; margin-bottom: 5px;">ğŸ“ éšæœºç»„å·è¯´æ˜</p>
                            <p style="color: #666; font-size: 13px; line-height: 1.6;">
                                è¯·è®¾ç½®å„ç±»å‹é¢˜ç›®çš„æ•°é‡ï¼Œç³»ç»Ÿå°†ä»é¢˜åº“ä¸­éšæœºæŠ½å–ç›¸åº”æ•°é‡çš„é¢˜ç›®ç»„æˆè¯•å·ã€‚<br>
                                è‡³å°‘éœ€è¦è®¾ç½®ä¸€ç§é¢˜ç›®ç±»å‹çš„æ•°é‡å¤§äº0ã€‚
                            </p>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å•é€‰é¢˜æ•°é‡</label>
                                <input type="number" name="single_count" id="single_count" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>å¤šé€‰é¢˜æ•°é‡</label>
                                <input type="number" name="multiple_count" id="multiple_count" value="0" min="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>åˆ¤æ–­é¢˜æ•°é‡</label>
                                <input type="number" name="judge_count" id="judge_count" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>éš¾åº¦ç­›é€‰</label>
                                <select name="difficulty" id="difficulty">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="easy">ç®€å•</option>
                                    <option value="medium">ä¸­ç­‰</option>
                                    <option value="hard">å›°éš¾</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>åˆ†ç±»ç­›é€‰</label>
                            <select name="category" id="random_category">
                                <option value="">å…¨éƒ¨</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 15px;">
                            <p style="color: #856404; font-size: 12px; margin: 0;">
                                âš ï¸ æç¤ºï¼šè¯·ç¡®ä¿é¢˜åº“ä¸­æœ‰è¶³å¤Ÿçš„é¢˜ç›®ï¼Œå¦åˆ™åˆ›å»ºè¯•å·ä¼šå¤±è´¥ã€‚
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <a href="{% url 'exam:exam_detail' exam.id %}" class="btn btn-secondary">å–æ¶ˆ</a>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºè¯•å·</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        function toggleGenerateType() {
            const generateType = document.getElementById('generate_type').value;
            console.log('ç”Ÿæˆæ–¹å¼æ”¹å˜ä¸º:', generateType);
            switchTab(generateType);
        }
        
        function switchTab(tab) {
            console.log('åˆ‡æ¢åˆ°æ ‡ç­¾:', tab);
            
            // æ›´æ–°ä¸‹æ‹‰æ¡†çš„å€¼
            const generateTypeSelect = document.getElementById('generate_type');
            if (generateTypeSelect) {
                generateTypeSelect.value = tab;
            }
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach((btn, index) => {
                btn.classList.remove('active');
                if ((tab === 'manual' && index === 0) || (tab === 'random' && index === 1)) {
                    btn.classList.add('active');
                    console.log('æ¿€æ´»æŒ‰é’®:', index, btn.textContent);
                }
            });
            
            // æ›´æ–°æ ‡ç­¾å†…å®¹
            const manualTab = document.getElementById('manual_tab');
            const randomTab = document.getElementById('random_tab');
            
            if (manualTab && randomTab) {
                manualTab.classList.remove('active');
                randomTab.classList.remove('active');
                
                if (tab === 'manual') {
                    manualTab.classList.add('active');
                    console.log('æ˜¾ç¤ºæ‰‹åŠ¨é€‰é¢˜æ ‡ç­¾');
                } else if (tab === 'random') {
                    randomTab.classList.add('active');
                    console.log('æ˜¾ç¤ºéšæœºç»„å·æ ‡ç­¾');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°æ ‡ç­¾å…ƒç´ :', { manualTab, randomTab });
            }
        }
        
        // ç­›é€‰é¢˜ç›®å‡½æ•°
        function filterQuestions() {
            const category = document.getElementById('filter_category').value;
            const type = document.getElementById('filter_type').value;
            const url = new URL(window.location.href);
            if (category) {
                url.searchParams.set('category', category);
            } else {
                url.searchParams.delete('category');
            }
            if (type) {
                url.searchParams.set('type', type);
            } else {
                url.searchParams.delete('type');
            }
            window.location.href = url.toString();
        }
        
        // è¡¨å•æäº¤éªŒè¯
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[method="post"]');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const generateType = document.getElementById('generate_type').value;
                    console.log('è¡¨å•æäº¤ï¼Œç”Ÿæˆæ–¹å¼:', generateType);
                    
                    if (generateType === 'random') {
                        const singleCount = parseInt(document.getElementById('single_count').value) || 0;
                        const multipleCount = parseInt(document.getElementById('multiple_count').value) || 0;
                        const judgeCount = parseInt(document.getElementById('judge_count').value) || 0;
                        
                        console.log('é¢˜ç›®æ•°é‡:', { singleCount, multipleCount, judgeCount });
                        
                        if (singleCount === 0 && multipleCount === 0 && judgeCount === 0) {
                            e.preventDefault();
                            alert('è¯·è‡³å°‘è®¾ç½®ä¸€ç§é¢˜ç›®çš„æ•°é‡å¤§äº0ï¼');
                            return false;
                        }
                        
                        // éªŒè¯è‡³å°‘æœ‰ä¸€ç§ç±»å‹å¤§äº0
                        if (singleCount < 0 || multipleCount < 0 || judgeCount < 0) {
                            e.preventDefault();
                            alert('é¢˜ç›®æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°ï¼');
                            return false;
                        }
                    } else {
                        const selectedQuestions = document.querySelectorAll('input[name="questions"]:checked');
                        if (selectedQuestions.length === 0) {
                            e.preventDefault();
                            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é“é¢˜ç›®ï¼');
                            return false;
                        }
                    }
                    
                    // å¦‚æœéªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºåŠ è½½æç¤º
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'åˆ›å»ºä¸­...';
                    }
                });
            } else {
                console.error('æ‰¾ä¸åˆ°è¡¨å•å…ƒç´ ');
            }
        });
        
        // å¯ç”¨/ç¦ç”¨åˆ†å€¼è¾“å…¥
        document.querySelectorAll('input[name="questions"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const questionId = this.value;
                const scoreInput = document.querySelector(`input[name="score_${questionId}"]`);
                if (scoreInput) {
                    scoreInput.disabled = !this.checked;
                }
            });
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ ‡ç­¾');
            const generateTypeSelect = document.getElementById('generate_type');
            if (generateTypeSelect) {
                const generateType = generateTypeSelect.value;
                console.log('å½“å‰ç”Ÿæˆæ–¹å¼:', generateType);
                switchTab(generateType);
            } else {
                console.error('æ‰¾ä¸åˆ°ç”Ÿæˆæ–¹å¼ä¸‹æ‹‰æ¡†');
            }
        });
        
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.toggleGenerateType = toggleGenerateType;
        window.switchTab = switchTab;
        window.filterQuestions = filterQuestions;
    </script>
</body>
</html>

